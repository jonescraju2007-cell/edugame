<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lesson ‚Ä¢ Rix EduGame</title>
  <link rel="stylesheet" href="styles.css"/>
  <script type="module">
    import {
      getParam, loadWorld, markLessonDone, isWorldUnlocked, qs, toast,
      applyTheme, toggleTheme, loadTheme, toggleMute, isMuted, loadProgress, calcLevel
    } from './app.js';

    function updateXP(){
      const xp=loadProgress().xp||0; const {level,percent}=calcLevel(xp);
      qs('#xpBox').innerHTML = `
        <div style="font-size:12px">Lv ${level} ‚Ä¢ XP ${xp}</div>
        <div class="progress" style="height:6px"><div style="width:${percent*100}%;background:#7cf;height:100%"></div></div>`;
    }

    async function boot(){
      applyTheme(); updateXP();
      const tbtn = qs('#theme'); const sb=qs('#sound');
      const setIcon=()=>tbtn.textContent=loadTheme()==='dark'?'üåô':'‚òÄÔ∏è';
      setIcon(); tbtn.onclick=()=>{ toggleTheme(); setIcon(); };
      sb.textContent = isMuted()?'üîá':'üîä'; sb.onclick=()=>{ const on=toggleMute(); sb.textContent=on?'üîä':'üîá'; };

      const wid = getParam('world') || 'w1';
      if (!isWorldUnlocked(wid)){
        toast("World is locked. Finish the previous world first.");
        setTimeout(()=>location.href='index.html', 1200); return;
      }
      const world = await loadWorld(wid);
      qs('#title').textContent = world.meta.title;
      qs('#intro').textContent = world.meta.intro;

      const list = qs('#lessons');
      for (const [key, lesson] of Object.entries(world.lessons)){
        const card = document.createElement('div');
        card.className = 'lesson-card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div><strong>${lesson.title}</strong></div>
            <span class="small">${key}</span>
          </div>
          <div class="small" style="opacity:.9">${lesson.html}</div>
        `;
        list.appendChild(card);
      }

      qs('#start').addEventListener('click', ()=>{
        markLessonDone(wid);
        location.href = `quiz.html?world=${wid}`;
      });
      qs('#back').addEventListener('click', ()=>location.href='index.html');
    }
    window.addEventListener('DOMContentLoaded', boot);
  </script>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo"></div>
      <div>
        <h1 id="title">Lesson</h1>
        <div id="intro" class="small"></div>
      </div>
      <div style="flex:1"></div>
      <div id="xpBox" style="text-align:right;min-width:200px"></div>
      <button id="theme" class="icon-btn" title="Toggle theme">üåô</button>
      <button id="sound" class="icon-btn" title="Toggle sound">üîä</button>
      <button id="back" class="btn secondary">‚Üê Worlds</button>
    </header>

    <div class="panel">
      <h2>Study Cards</h2>
      <div id="lessons"></div>
      <div style="height:12px"></div>
      <button class="btn" id="start">Start Quiz ‚Üí</button>
    </div>
  </div>
</body>
</html>

